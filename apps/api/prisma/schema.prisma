/// Schema do banco de dados TorqueHub — PostgreSQL via Prisma.
/// Modelos: Workshop, Customer, Vehicle, ServiceOrder, ServiceOrderItem, Media.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Oficina — tenant principal do sistema.
model Workshop {
  id        String   @id @default(uuid())
  name      String
  document  String   @unique // CNPJ ou CPF
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  customers     Customer[]
  vehicles      Vehicle[]
  serviceOrders ServiceOrder[]
  users         User[]

  @@map("workshops")
}

/// Cliente vinculado a uma oficina.
model Customer {
  id         String   @id @default(uuid())
  workshopId String   @map("workshop_id")
  name       String
  document   String? // CPF
  phone      String?
  email      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  workshop      Workshop       @relation(fields: [workshopId], references: [id])
  vehicles      Vehicle[]
  serviceOrders ServiceOrder[]

  @@map("customers")
}

/// Veículo de um cliente, vinculado a uma oficina.
model Vehicle {
  id         String   @id @default(uuid())
  workshopId String   @map("workshop_id")
  customerId String   @map("customer_id")
  plate      String
  brand      String
  model      String
  year       Int?
  color      String?
  mileage    Int?     @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  workshop      Workshop       @relation(fields: [workshopId], references: [id])
  customer      Customer       @relation(fields: [customerId], references: [id])
  serviceOrders ServiceOrder[]

  @@map("vehicles")
}

/// Ordem de serviço com itens, status e token público.
model ServiceOrder {
  id              String             @id @default(uuid())
  workshopId      String             @map("workshop_id")
  customerId      String             @map("customer_id")
  vehicleId       String             @map("vehicle_id")
  description     String
  status          ServiceOrderStatus @default(DRAFT)
  observations    String?
  totalAmount     Int                @default(0) // valor em centavos
  publicToken     String?            @unique @map("public_token") // link público para o cliente
  quoteExpiresAt  DateTime?          @map("quote_expires_at") // validade do orçamento (30 dias)
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  workshop Workshop           @relation(fields: [workshopId], references: [id])
  customer Customer           @relation(fields: [customerId], references: [id])
  vehicle  Vehicle            @relation(fields: [vehicleId], references: [id])
  items    ServiceOrderItem[]
  media    Media[]

  @@map("service_orders")
}

/// Item individual de uma ordem de serviço.
model ServiceOrderItem {
  id             String @id @default(uuid())
  serviceOrderId String @map("service_order_id")
  description    String
  quantity       Int    @default(1)
  unitPrice      Int    @default(0) // valor em centavos

  serviceOrder ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@map("service_order_items")
}

/// Mídias (fotos/vídeos) associadas a uma ordem de serviço.
model Media {
  id             String    @id @default(uuid())
  serviceOrderId String    @map("service_order_id")
  type           MediaType
  url            String
  caption        String?
  createdAt      DateTime  @default(now()) @map("created_at")

  serviceOrder ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@map("media")
}

/// Status possíveis de uma ordem de serviço.
enum ServiceOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("service_order_status")
}

enum MediaType {
  PHOTO
  VIDEO

  @@map("media_type")
}

/// Usuário do sistema — platform admin, dono de oficina ou mecânico.
model User {
  id                 String   @id @default(uuid())
  workshopId         String?  @map("workshop_id")
  name               String
  email              String   @unique
  passwordHash       String   @map("password_hash")
  role               UserRole @default(MECHANIC)
  mustChangePassword Boolean  @default(false) @map("must_change_password")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  workshop Workshop? @relation(fields: [workshopId], references: [id])

  @@map("users")
}

/// Papéis de usuário no sistema.
enum UserRole {
  PLATFORM_ADMIN
  WORKSHOP_OWNER
  MECHANIC

  @@map("user_role")
}
